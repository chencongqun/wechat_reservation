<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<meta name="format-detection" content="telephone=no" />
<title>我的菜单</title>
<link rel="stylesheet" type="text/css" href="http://imgcache.life.qq.com/www/misc/styles/wei_canyin_v1.8.4.css?v=1.0.11" />
<link rel="stylesheet" type="text/css" href="http://imgcache.life.qq.com/www/misc/styles/wei_dialog_v1.2.1.css?v=1.0.1" />
<script src="http://imgcache.life.qq.com/www/misc/scripts/wei_webapp_v2_common_v1.9.4.js?v=1.0.5"></script>
<script src="http://imgcache.life.qq.com/www/misc/scripts/wei_dialog_v2.2.3.js?v=1.0.0"></script>
</head>
<body id="page_intelOrder" class="myOrderCon">
<div class="center">
  <header> <span class="pCount">请叫服务员下单</span>
    <label><i>共计：</i><b class="duiqi" id="total"></b><b class="duiqi">元</b></label>
  </header>
  <section>
    <article>
      <h2>我的菜单
        <button class="btn_add emptyIt" id="clearBtn">清空</button>
        <button class="btn_add" onClick="location.href='/weixin/dish/list?qrcode=q13965126946064&code=00786e66b2c7b371af5c5e2175875796&ticket=00786e66b2c7b371af5c5e2175875796&ticketSource=&from=weixin.dish.menu#wechat_webview_type=1'">+加菜</button>
      </h2>
      <ul class="myorder">
        <li> <span class="dishName">爽口萝卜皮</span> <i>16元/例</i>
          <section class="bbox" dishid="1498015230" dishName="爽口萝卜皮">
            <input class="btn-reduce" type="button" value="-" />
            <input class="numBox" name="numBox" type="text" value="1" price="16" disabled="disabled"/>
            <input type="button" class="btn-plus" value="+" />
          </section>
        </li>
        <li> <span class="dishName">百味猪手</span> <i>16元/只</i>
          <section class="bbox" dishid="3604923622" dishName="百味猪手">
            <input class="btn-reduce" type="button" value="-" />
            <input class="numBox" name="numBox" type="text" value="1" price="16" disabled="disabled"/>
            <input type="button" class="btn-plus" value="+" />
          </section>
        </li>
        <li> <span class="dishName">卤水自磨豆腐</span> <i>19元/例</i>
          <section class="bbox" dishid="2488142856" dishName="卤水自磨豆腐">
            <input class="btn-reduce" type="button" value="-" />
            <input class="numBox" name="numBox" type="text" value="1" price="19" disabled="disabled"/>
            <input type="button" class="btn-plus" value="+" />
          </section>
        </li>
        <li> <span class="dishName">卤水拼盘</span> <i>39元/例</i>
          <section class="bbox" dishid="1434520843" dishName="卤水拼盘">
            <input class="btn-reduce" type="button" value="-" />
            <input class="numBox" name="numBox" type="text" value="1" price="39" disabled="disabled"/>
            <input type="button" class="btn-plus" value="+" />
          </section>
        </li>
        <li> <span class="dishName">灵渠醉鱼</span> <i>19元/例</i>
          <section class="bbox" dishid="1168281083" dishName="灵渠醉鱼">
            <input class="btn-reduce" type="button" value="-" />
            <input class="numBox" name="numBox" type="text" value="1" price="19" disabled="disabled"/>
            <input type="button" class="btn-plus" value="+" />
          </section>
        </li>
      </ul>
    </article>
  </section>
  <footer class="footFix"> <a onClick="shareMenu()">分享给好友</a> </footer>
</div>
<script>var pageName = 'menuFilled';</script>
<script>
window.shareData = {"appid":"wx75802e2995b1ed05","imgUrl":"http:\/\/qqfood.tc.qq.com\/meishio\/16\/ccc3c7cd-ca21-4f00-a32e-76252f7a0eaa\/0","timeLineLink":"http:\/\/life.qq.com\/qr\/t13621298894431#wechat_redirect","tTitle":"\u5173\u6ce8\u53ef\u83b7\u5f97\u300c\u6f13\u6c5f\u53c8\u4e00\u8f69\u300d\u5fae\u751f\u6d3b\u4f1a\u5458\u5361","tContent":"\u6f13\u6c5f\u53c8\u4e00\u8f69","sendFriendLink":"http:\/\/life.qq.com\/qr\/f13621298894431#wechat_redirect","fTitle":"\u6f13\u6c5f\u53c8\u4e00\u8f69","fContent":"\u5173\u6ce8\u53ef\u83b7\u5f97\u300c\u6f13\u6c5f\u53c8\u4e00\u8f69\u300d\u5fae\u751f\u6d3b\u4f1a\u5458\u5361","wContent":"#\u5fae\u4fe1\u626b\u63cf\u4e8c\u7ef4\u7801#\u6211\u521a\u5728\u6f13\u6c5f\u53c8\u4e00\u8f69\u626b\u63cf\u4e8c\u7ef4\u7801\uff0c\u8f7b\u677e\u83b7\u5f97\u5fae\u751f\u6d3b\u4f1a\u5458\u5361\uff0c\u5f97\u52302863463154\uff0c\u9177\u70ab\u53c8\u597d\u73a9\uff01","wLink":null};
var ticket = '00786e66b2c7b371af5c5e2175875796',
    code = '00786e66b2c7b371af5c5e2175875796',
    ticketSource = '',
    wticket = 'f138870da652c61f17e2f2ac468a38d0',
    qrcode = 'q13965126946064';

    var pageName = pageName ? pageName : '';


// 分享
function shareFriend(appid, imgUrl, sendFriendLink, fContent, fTitle) {
    WeixinJSBridge.invoke('sendAppMessage',{
                            "appid":appid,
                            "img_url":imgUrl,
                            "img_width":"640",
                            "img_height":"640",
                            "link":sendFriendLink,
                            "desc":fContent,
                            "title":fTitle
                            }, function(res) {
                            _report('send_msg', res.err_msg);
                            })
}
function shareTimeline(imgUrl, timeLineLink, tContent, tTitle) {
    WeixinJSBridge.invoke('shareTimeline',{
                            "img_url":imgUrl,
                            "img_width":"640",
                            "img_height":"640",
                            "link":timeLineLink,
                            "desc": tContent,
                            "title": tTitle
                            }, function(res) {
                            _report('timeline', res.err_msg);
                            });
}
function shareWeibo(wContent, wLink) {
    WeixinJSBridge.invoke('shareWeibo',{
                            "content":wContent,
                            "url":wLink,
                            }, function(res) {
                            _report('weibo', res.err_msg);
                            });
}
// 当微信内置浏览器完成内部初始化后会触发WeixinJSBridgeReady事件。
document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {

        // 发送给好友
        WeixinJSBridge.on('menu:share:appmessage', function(argv){
            if (pageName == 'menuFilled') {

                var params = {
                    'qrcode' : qrcode,
                    'ticket' : ticket,
                    'ticketSource' : ticketSource
                };

                MLoading.show('加载中');
                setTimeout(function(){MLoading.hide();},3000);
                _doAjax('/weixin/dish/share', 'POST', params, function(ret){
                    MLoading.hide();
                    if (ret['code'] != 0) {
                        alert(ret['message']);
                        return;
                    }
                    var result = ret['result']['data'];

                    shareFriend(result.appid, result.img_url, result.link, result.desc, result.title);
                });

            } else {
                shareFriend(window.shareData.appid, window.shareData.imgUrl, window.shareData.sendFriendLink, window.shareData.fContent, window.shareData.fTitle);
            }
        });

        // 分享到朋友圈
        WeixinJSBridge.on('menu:share:timeline', function(argv){
            if (pageName == 'menuFilled') {

                var params = {
                    'qrcode' : qrcode,
                    'ticket' : ticket,
                    'ticketSource' : ticketSource
                };

                MLoading.show('加载中');
                setTimeout(function(){MLoading.hide();},3000);
                _doAjax('/weixin/dish/share', 'POST', params, function(ret){
                    MLoading.hide();
                    if (ret['code'] != 0) {
                        alert(ret['message']);
                        return;
                    }
                    var result = ret['result']['data'];

                    shareTimeline(result.img_url, result.link, result.desc, result.title);
                });

            } else {

                shareTimeline(window.shareData.imgUrl, window.shareData.timeLineLink, window.shareData.tContent, window.shareData.tTitle);
            }
        });

        // 分享到微博
        WeixinJSBridge.on('menu:share:weibo', function(argv){
            if (pageName == 'menuFilled') {

                var params = {
                    'qrcode' : qrcode,
                    'ticket' : ticket,
                    'ticketSource' : ticketSource
                };

                MLoading.show('加载中');
                setTimeout(function(){MLoading.hide();},3000);
                _doAjax('/weixin/dish/share', 'POST', params, function(ret){
                    MLoading.hide();
                    if (ret['code'] != 0) {
                        alert(ret['message']);
                        return;
                    }
                    var result = ret['result']['data'];

                    shareWeibo(result.title, result.link);
                });

            } else {

                shareWeibo(window.shareData.wContent, window.shareData.wLink);
            }
        });
     }, false)


     function placeOrder(orderId, cardid) {

        params = {
            'ticket' : ticket,
            ticketSource : ticketSource,
            action : 'placeOrder',
            orderId : orderId,
            code : code,
            qrcode : qrcode
        };

        MLoading.show('加载中');
        setTimeout(function(){MLoading.hide();},3000);
        _doAjax('/weixin/'+cardid+'/showDishOrder', 'POST', params, function(ret) {
            MLoading.hide();
            if (ret['code'] == 100) {
                location.href = location.origin + '/weixin/'+cardid+'/dishWaimaiCardPay?action=payByCard&ticket=' + ticket + '&qrcode=' + qrcode + '&orderId='+orderId+'#wechat_webview_type=1';
            } else if (ret['code'] != 0) {
                alert(ret['message']);
                return;
            }

            isWeixin5=1;
            // 微信支付
            if (isWeixin5) {
                    var weixinPay = ret.result.weixinPay;
                    var requestData = {};
                    requestData.appId = weixinPay.appId; //公众号名称,由商户传入
                    requestData.timeStamp = weixinPay.timeStamp + ''; //时间戳 这里随意使用了一个值
                    requestData.nonceStr = weixinPay.nonceStr; //随机串
                    requestData.package = weixinPay.package; // 扩展字段,由商户传入
                    requestData.signType = weixinPay.signType; //微信签名方式:sha1
                    requestData.paySign = weixinPay.paySign; //微信签名
                    // 下单成功 => 微信支付
                    WeixinJSBridge.invoke('getBrandWCPayRequest', requestData, function(d){
                                          // 支付回调
                                          // alert(d.err_msg);
                                          if (d.err_msg == 'get_brand_wcpay_request:ok') {
                                               location.href = location.origin + '/weixin/'+cardid+'/listDishOrder?ticket=' + ticket + '&qrcode=' + qrcode + '&code=' + code + '#wechat_webview_type=1';
                                            // 支付成功
                                          } else if(d.err_msg == 'get_brand_wcpay_request:cancel') {
                                            // 取消支付
                                          } else {
                                            // 支付失败
                                          }
                                      });

            }
        });
     }

</script>
<script type="text/javascript">

var reduce = _qAll('.btn-reduce');
var plus = _qAll('.btn-plus');
var share = _qAll('.shareBtn');
//金额累加操作
function tototal(){
    var total = 0;
    var nums = _qAll('.numBox');
    for( var j = 0; j < nums.length; j++){
        total = total + nums[j].value * nums[j].getAttribute('price');
    }

    endTotal = parseFloat(total).toFixed(2) * 100/100;
    // endTotal = endTotal == parseInt(endTotal) ? parseInt(endTotal) : endTotal;
    _q('#total').innerHTML = endTotal;
    return endTotal;
}

tototal();//初始化金额

function doSelectBtn(){
    var btn = _qAll("article ul li .bbox");
        var btnIndex = 0,btnLength = btn.length;
    for(btnIndex;btnIndex<btnLength;btnIndex++){

        var countNumText=parseInt(btn[btnIndex].children[1].value),
            btnAdd=btn[btnIndex].children[2],
            btnMin=btn[btnIndex].children[0];

        var iTimeout,iInterval,originalNum,
            beforeRemoveDish = false;
        btnAdd.addEventListener(_movestartEvt,function(){
            // alert('aaa')
            var _self = this;
            originalNum = parseInt(_self.parentNode.children[1].value, 10);
            countNumText =  originalNum +1;
            _self.parentNode.children[1].value = countNumText;
            iTimeout = setTimeout(function(){
                iInterval = setInterval(function(){
                    countNumText++;
                    _self.parentNode.children[1].value = countNumText;
                },100)
            },1000)
        })

        btnAdd.addEventListener(_moveendEvt,function(){
            //alert(countNumText)
            //_doAjax()...

            clearTimeout(iTimeout);
            clearInterval(iInterval);
            tototal();

            var _self = this;
            var countNumText =  parseInt(_self.parentNode.children[1].value, 10);
            var dishid = _self.parentNode.getAttribute('dishid');
            ajaxDishReset(dishid, countNumText, function(){}, function() {

                            _self.parentNode.children[1].value = originalNum;
                            tototal();
                         });

            // countNumText = 0;
        })

        btnMin.addEventListener(_movestartEvt,function(){
            var _self = this;
            originalNum = parseInt(_self.parentNode.children[1].value, 10);
            countNumText =  originalNum -1;

            if(countNumText <=0){
                beforeRemoveDish = true;
//                countNumText = 0;
//                _self.parentNode.children[1].value = countNumText;
            }else{
                _self.parentNode.children[1].value = countNumText;

                iTimeout = setTimeout(function(){
                    iInterval = setInterval(function(){
                        if(countNumText<=0){
                            beforeRemoveDish = true;
                            _self.parentNode.children[1].value = originalNum;
                            clearInterval(iInterval);
                            return; 
                        }
                        countNumText--;
                        _self.parentNode.children[1].value = countNumText;
                    },100)
                },1000)
            }
        })

        btnMin.addEventListener(_moveendEvt,function(){
            clearTimeout(iTimeout);
            clearInterval(iInterval);
            _self = this;

            var dishid = _self.parentNode.getAttribute('dishid');
            var dishName = _self.parentNode.getAttribute('dishName');
            var countNumText =  parseInt(_self.parentNode.children[1].value, 10);

            if(beforeRemoveDish){

                setTimeout(function(){
                    MDialog.confirm(
                        '', '是否删除' + dishName +'？', null,
                        '确定', function(){

                            ajaxDishRemove(dishid, function(){

                                                var li = _self.parentNode.parentNode;
                                                li.parentNode.removeChild(li);
                                                var total = tototal();

                                                // 没有数据后刷新页面
                                                if (total == 0) {
                                                    location.reload();
                                                }
                                            }, function() {

                                                    _self.parentNode.children[1].value = originalNum;
                                                    tototal();
                                            });

                        }, null,
                        '取消', null, null,
                        null, true, true
                    );

                },500)
                beforeRemoveDish = false;
            } else {
                tototal();
                ajaxDishReset(dishid, countNumText, function(){}, function() {

                                _self.parentNode.children[1].value = originalNum;
                                tototal();
                            });
            }
        })
    } // for

    function ajaxDishReset(dishid, o2uNum, successCallback, errorCallback) {

        var params = {
            'dishid' : dishid,
            'qrcode' : qrcode,
            'ticket' : ticket,
            'code' : code,
            'o2uNum' : o2uNum
        };

        _doAjax('/weixin/dish/menu?action=update&type=reset', 'POST', params, function(ret) {
                if (ret['code'] != 0) {

                    errorCallback();
                    alert(ret['message']);
                    return;
                } else {
                    successCallback();
                }
        });
    } // ajaxDishReset

    function ajaxDishRemove(dishid, successCallback, errorCallback) {

        var params = {
            'dishid' : dishid,
            'qrcode' : qrcode,
            'code' : code,
            'ticket' : ticket,
        };

        _doAjax('/weixin/dish/menu?action=remove', 'POST', params, function(ret) {
            if (ret['code'] != 0) {

                errorCallback();
                alert(ret['message']);
                return;
            } else {
                successCallback();
            }
        });
    } // ajaxDishRemove

} // doSelectBtn

function shareMenu(){
    var params = {
        'qrcode' : qrcode,
        'ticket' : ticket,
        'code' : code,
        'ticketSource' : ticketSource
    };

    MLoading.show('加载中');
    setTimeout(function(){MLoading.hide();},3000);
    _doAjax('/weixin/dish/share', 'POST', params, function(ret){
        MLoading.hide();
        if (ret['code'] != 0) {
            alert(ret['message']);
            return;
        }
        var result = ret['result']['data'];

        WeixinJSBridge.invoke('sendAppMessage',{
                "appid":result.appid,
                "img_url":result.img_url,
                "img_width":"640",
                "img_height":"640",
                "link":result.link,
                "desc":result.desc,
                "title":result.title
                }, function(res) {
                    if (res.err_msg == 'send_app_msg:ok' || res.err_msg == 'send_app_msg:confirm') {
                    }

                 });

        }); // _doAjax
}

_onPageLoaded(function(){

    var reduce = _qAll('.btn-reduce');
    var plus = _qAll('.btn-plus');
    tototal();//初始化金额
    doSelectBtn();

    _q('#clearBtn').onclick = function() {

        MDialog.confirm(
            '', '是否清空菜单？', null,
            '确定', function(){
                window.location.href = "/weixin/dish/menu?action=clearMenu&qrcode="+qrcode+"&ticket="+ticket + "&code=" +code + '#wechat_webview_type=1';
            }, null,
            '取消', null, null,
            null, true, true
        );

    };
});

</script>
<!--script src="http://imgcache.life.qq.com/www/misc/scripts/wei_webapp_copyright_v1.7.1.js?v=1.0.0"></script-->
</body>
</html>
